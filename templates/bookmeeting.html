{% extends 'base.html' %}

{% block header %}
    <ul style="margin-left: 0">
        <li v-for="m in meetingRoomList"
            style="padding: 0; margin: 5px; list-style-type: none; display: inline-block;">
            <button @click="renderBookMeeting(m.id, m.name, $event)"
                    type="button"
                    class="btn btn-white btn-primary">
                <% m.name %>
            </button>
        </li>
    </ul>
{% endblock %}
{% block page_content %}
    <div class="row">
        <div class="col-sm-9">
            <h4 class="blue">
                <span style="color: #1B6AAA">
                <% currentChooseMeetingRoom %>
                </span>
                预定视图</h4>
            <div class="space"></div>
            <div id="calendar"></div>
        </div>

        <div class="col-sm-3">
            <div class="widget-box transparent">
                <div class="widget-header">
                    <h4>您的预定</h4>
                </div>

                <div class="widget-body">
                    <div class="widget-main no-padding">
                        <div id="external-events">
                            <div class="external-event label-success"
                                 data-class="label-success">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室1
                            </div>

                            <div class="external-event label-danger" data-class="label-danger">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室2
                            </div>

                            <div class="external-event label-purple" data-class="label-purple">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室3
                            </div>

                            <div class="external-event label-yellow" data-class="label-yellow">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室4
                            </div>

                            <div class="external-event label-pink" data-class="label-pink">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室5
                            </div>

                            <div class="external-event label-info" data-class="label-info">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室6
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="widget-box transparent">
                <div class="widget-header">
                    <h4>今日会议室预定情况</h4>
                </div>

                <div class="widget-body">
                    <div class="widget-main no-padding">
                        <div id="external-events">
                            <div class="external-event label-success"
                                 data-class="label-success">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室1
                            </div>

                            <div class="external-event label-danger" data-class="label-danger">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室2
                            </div>

                            <div class="external-event label-purple" data-class="label-purple">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室3
                            </div>

                            <div class="external-event label-yellow" data-class="label-yellow">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室4
                            </div>

                            <div class="external-event label-pink" data-class="label-pink">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室5
                            </div>

                            <div class="external-event label-info" data-class="label-info">
                                <i class="ace-icon fa fa-arrows"></i>
                                会议室6
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block external_script %}
    <script type="text/javascript">
        var renderFullCalendar = function (id, name) {
            var date = new Date();
            var d = date.getDate();
            var m = date.getMonth();
            var y = date.getFullYear();
            var calendar = $('#calendar').fullCalendar({
                lang: 'zh-CN',
                minTime: '06:00:00',
                maxTime: '23:59:59',
                displayEventTime: true,
                displayEventEnd: true,
                aspectRatio: 2.2,
                firstDay: 1,
                defaultView: 'agendaWeek',
                allDaySlot: false,
                buttonText: {
                    month: '月视图',
                    agendaWeek: '周视图',
                    agendaDay: '天视图'
                },
                buttonHtml: {
                    prev: '<i class="ace-icon fa fa-chevron-left"></i>',
                    next: '<i class="ace-icon fa fa-chevron-right"></i>'
                },
                header: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'agendaDay,agendaWeek,month'
                },
                events: [
                    {
                        title: name,
                        start: new Date(y, m, d, 16, 0),
                        end: new Date(y, m, d, 17, 0),
                        allDay: false,
                        className: 'label-info'
                    }
                ],
                eventResize: function (event, delta, revertFunc) {
                    alert(event.title + " end is now " + event.end.format());
                    if (!confirm("is this okay?")) {
                        revertFunc();
                    }
                },
                editable: true,
                droppable: true,
                drop: function (date) {
                    var originalEventObject = $(this).data('eventObject');
                    var $extraEventClass = $(this).attr('data-class');
                    var copiedEventObject = $.extend({}, originalEventObject);
                    copiedEventObject.start = date;
                    copiedEventObject.allDay = false;
                    if ($extraEventClass) copiedEventObject['className'] = [$extraEventClass];
                    $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
                    if ($('#drop-remove').is(':checked')) {
                        $(this).remove();
                    }
                },
                selectable: true,
                selectHelper: true,
                select: function (start, end, allDay) {
                    window.location.href = "{% url 'book' %}?meetingroom=x";
{#                    bootbox.prompt("会议室预定", function (title) {#}
{#                        if (title !== null) {#}
{#                            calendar.fullCalendar('renderEvent',#}
{#                                {#}
{#                                    title: title,#}
{#                                    start: start,#}
{#                                    end: end,#}
{#                                    allDay: allDay,#}
{#                                    className: 'label-info'#}
{#                                },#}
{#                                true // make the event "stick"#}
{#                            );#}
{#                        }#}
{#                    });#}
{##}
{#                    calendar.fullCalendar('unselect');#}
                },
                eventClick: function (calEvent, jsEvent, view) {
                    //点击事件后的操作
                    var modal =
                        '<div class="modal fade">\
                          <div class="modal-dialog">\
                           <div class="modal-content">\
                            <div class="modal-body">\
                             <button type="button" class="close" data-dismiss="modal" style="margin-top:-10px;">&times;</button>\
                              <form class="no-margin">\
                                <label>修改会议主题 &nbsp;</label>\
                                 <input class="middle" autocomplete="off" type="text" value="' + calEvent.title + '" />\
					        <button type="submit" class="btn btn-sm btn-success"><i class="ace-icon fa fa-check"></i>保存</button>\
				          </form>\
				         </div>\
				        <div class="modal-footer">\
					     <button type="button" class="btn btn-sm btn-danger" data-action="delete"><i class="ace-icon fa fa-trash-o"></i>删除预定</button>\
					     <button type="button" class="btn btn-sm" data-dismiss="modal"><i class="ace-icon fa fa-times"></i>取消</button>\
				        </div>\
			           </div>\
			          </div>\
			        </div>';

                    var modal = $(modal).appendTo('body');
                    modal.find('form').on('submit', function (ev) {
                        ev.preventDefault();

                        calEvent.title = $(this).find("input[type=text]").val();
                        calendar.fullCalendar('updateEvent', calEvent);
                        modal.modal("hide");
                    });
                    modal.find('button[data-action=delete]').on('click', function () {
                        calendar.fullCalendar('removeEvents', function (ev) {
                            return (ev._id == calEvent._id);
                        });
                        modal.modal("hide");
                    });
                    modal.modal('show').on('hidden', function () {
                        modal.remove();
                    });
                }
            });
        };

        var token = "{{ csrf_token }}";
        var data = {
            meetingRoomInfoUrl: "{% url 'bookmeeting:meetingroot-info' %}",
            meetingRoomList: '',
            currentChooseMeetingRoom: '',
            defaultShowMeeting: ''
        };
        // vue
        var app = new Vue({
            el: "#book-page-content",
            delimiters: ["<%", "%>"],
            data: data,
            mounted: function () {
                this.getMeetingRoom();
                this.renderBookMeeting(this.defaultShowMeeting.id, this.defaultShowMeeting.name)
            },
            methods: {
                getMeetingRoom: function () {
                    this.$http.get(this.meetingRoomInfoUrl).then(function (response) {
                        var result = response.data;
                        // 把列表中的第一个作为页面的默认渲染
                        this.defaultShowMeeting = result[0];
                        this.currentChooseMeetingRoom = result[0]['name'];
                        this.meetingRoomList = result
                    })
                },
                renderBookMeeting: function (id, name, e) {
                    $("#calendar").replaceWith("<div id='calendar'></div>");
                    this.currentChooseMeetingRoom = name;
                    renderFullCalendar(id, name)
                }
            }

        });
    </script>
{% endblock %}
